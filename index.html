<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa GPON – Ventanilla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.min.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    .legend {
      background: white;
      padding: 10px 14px;
      line-height: 1.5em;
      border-radius: 8px;
      font-family: Arial, sans-serif;
      font-size: 13px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .leaflet-bottom .legend {
      margin-bottom: 30px; 
    }

    .legend h4 {
      margin: 0 0 6px 0;
      font-size: 14px;
      text-align: center;
      color: #333;
    }
    
    .info-legend-box div {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .info-legend-box span {
      display: inline-block;
      width: 18px;
      height: 10px;
      margin-right: 8px;
      border: 1px solid #555;
    }
    
    .poste-id-tooltip {
      background: rgba(255, 255, 255, 0.75);
      border: none;
      box-shadow: none;
      font-weight: bold;
      font-size: 10px;
      color: #000;
      padding: 2px 4px;
      border-radius: 3px;
    }

    /* ESTILOS DASHBOARD */
    .dashboard-box {
      max-height: 300px;
      overflow-y: auto; /* Permite el scroll */
      width: 250px;
    }
    .dashboard-list {
      padding-left: 10px;
    }
    
    .pmi-list {
      display: block; /* Asegura que la lista sea vertical */
    }
    .pmi-list > div {
      font-size: 12px; /* Letra más pequeña */
      display: flex;
      align-items: center;
      margin-bottom: 3px; /* Espacio reducido */
      flex-shrink: 0; /* Evita que se aplasten */
    }
    .pmi-dashboard-box span {
      width: 10px; /* Círculo más pequeño */
      height: 10px; /* Círculo más pequeño */
      border-radius: 50%;
      border: 1px solid #000;
      margin-right: 6px; /* Espacio reducido */
      display: inline-block;
      flex-shrink: 0; /* Evita que el círculo se aplaste */
    }
    
    .dashboard-zone-summary {
      margin-bottom: 5px;
      font-size: 13px;
    }
    
    .toggle-list {
      cursor: pointer;
      color: blue;
      font-family: monospace;
      font-weight: bold;
      padding: 0 5px;
    }
    .dashboard-id-list {
      list-style: none;
      padding-left: 15px;
      margin: 0;
      font-size: 11px;
    }
    .dashboard-id-item {
      cursor: pointer;
      padding: 2px;
      white-space: nowrap;
    }
    .dashboard-id-item:hover {
      background-color: #f0f0f0;
      font-weight: bold;
    }
    
    .dashboard-list-header {
      font-weight: bold;
      font-size: 12px;
      color: #555;
      margin: 5px 0;
      border-bottom: 1px solid #ccc;
      padding-bottom: 3px;
    }
    
    .leaflet-bar a.find-me-btn {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="%23333" d="M256 0c-17.67 0-32 14.33-32 32v14.08C108.7 61.12 21.12 108.7 6.08 224H32c17.67 0 32 14.33 32 32s-14.33 32-32 32H6.08C21.12 403.3 108.7 490.9 224 505.9V480c0-17.67 14.33-32 32-32s32 14.33 32 32v25.92C403.3 490.9 490.9 403.3 505.9 288H480c-17.67 0-32-14.33-32-32s14.33-32 32-32h25.92C490.9 108.7 403.3 21.12 288 6.08V32c0-17.67-14.33-32-32-32zM256 128c-70.69 0-128 57.31-128 128s57.31 128 128 128 128-57.31 128-128-57.31-128-128-128zm0 192c-35.35 0-64-28.65-64-64s28.65-64 64-64 64 28.65 64 64-28.65 64-64 64z"/></svg>');
      background-size: 16px 16px;
      background-position: center;
      background-repeat: no-repeat;
    }

    .leaflet-bar a.toggle-legends-btn {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="18" height="18"><path fill="%23333" stroke="%23333" stroke-width="3" stroke-linecap="round" d="M4 7h22M4 15h22M4 23h22"/></svg>');
      background-size: 18px 18px;
      background-position: center;
      background-repeat: no-repeat;
    }
    .info-panel.hidden {
      display: none;
    }

    .poste-existente-marker {
      width: 10px;
      height: 10px;
      background-color: #0000FF; /* Azul */
      border: 1px solid #000; /* Borde Negro */
      opacity: 0.8;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    // =======================================================
    // --- INICIO: MAPA BASE ---
    // =======================================================
    const map = L.map('map', { maxZoom: 20 }).setView([-11.87, -77.13], 13);
    
    const pmiCounts = {}; 
    
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 19
    });
    
    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
      maxZoom: 20
    });
    
    esriSat.addTo(map);
    
    const baseMaps = {
      "Calles (OpenStreetMap)": osm,
      "Satélite (Esri)": esriSat
    };
    
    const overlayMaps = {};

    const layerControl = L.control.layers(baseMaps, overlayMaps, {
      position: 'topright',
      collapsed: true
    });
    
    // --- RUTAS ESTÁTICAS (Sin tilde) ---
    const rutas = [
      { nombre: "Pachacutec", color: "#FFA500", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/Rutas_Pachacutec.kml" },
      { nombre: "Villa Los Reyes", color: "#FF0000", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/Rutas_Villa%20los%20reyes.kml" },
      { nombre: "Ventanilla Centro", color: "#8000FF", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/Rutas_Ventanilla%20centro.kml" }
    ];

    rutas.forEach(r => {
      const rutaLayer = omnivore.kml(r.url, null, L.geoJson(null, {
        style: { color: r.color, weight: 3, opacity: 0.9 }
      }));
      rutaLayer.addTo(map);
      layerControl.addOverlay(rutaLayer, "Ruta: " + r.nombre);
    });

  	// =======================================================
  	// --- PMIs (CON CLUSTERING) ---
  	// =======================================================
  	const puntosFijosKML = [
  	  { nombre: "PMIs Pachacutec", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/PMIs%20Pachacutec.kml" },
  	  { nombre: "PMIs Ventanilla Centro", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/PMIs%20Ventanilla%20centro.kml" },
  	  { nombre: "PMIs Villa Los Reyes", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/PMIs%20Villa%20los%20reyes.kml" }
  	];
  
  	const estiloPuntosFijos = {
  	  radius: 8,
  	  fillColor: "#008f39", // Verde
  	  color: "#000",
  	  weight: 1,
  	  opacity: 1,
  	  fillOpacity: 0.8
  	};
  
  	puntosFijosKML.forEach(p => {
  	  pmiCounts[p.nombre] = 0; 
      
      // Crear grupo de cluster
      const clusterGroup = L.markerClusterGroup();

  	  const capaPuntosFijos = L.geoJson(null, {
    		pointToLayer: function (feature, latlng) {
    		  return L.circleMarker(latlng, estiloPuntosFijos);
    		},
    		onEachFeature: function (feature, layer) {
    		  pmiCounts[p.nombre]++; 
    		  const id = feature.properties.name;
    		  let popupContent = id || "Punto Fijo";
    		  if (id) {
      			layer.bindTooltip(id, {
      			  permanent: true, direction: 'auto',
      			  className: 'poste-id-tooltip', offset: [0, -10]
      			});
    		  }
    		  if (feature.properties.description) {
      			const descLimpia = feature.properties.description.replace(/(\r\n|\n|\r)/gm, "<br>");
      			popupContent += `<br><hr>${descLimpia}`;
    		  }
    		  layer.bindPopup(popupContent);
    		}
  	  });
  	  
  	  const kmlRun = omnivore.kml(p.url, null, capaPuntosFijos);
      
      // Al cargar, añadir al cluster y luego al mapa
  	  kmlRun.on('ready', function() {
        clusterGroup.addLayer(kmlRun);
        map.addLayer(clusterGroup);
        layerControl.addOverlay(clusterGroup, "PMI: " + p.nombre); // Añadir el CLUSTER al filtro
    		updatePmiDashboard();
  	  });
  	});
   
    layerControl.addTo(map);

    
    // =======================================================
    // --- POSTES EXISTENTES (CON CLUSTERING) ---
    // =======================================================
    
    const iconoPosteExistente = L.divIcon({
      className: 'poste-existente-marker',
      iconSize: [12, 12] 
    });

    // --- Bloque 1: Pachacutec ---
    const urlPostesExistentes = "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/PA_postes%20existentes.kml";
    const clusterPA = L.markerClusterGroup(); // Cluster

    const capaPostesExistentes = L.geoJson(null, {
      pointToLayer: function (feature, latlng) {
        return L.marker(latlng, { icon: iconoPosteExistente });
      },
      onEachFeature: function (feature, layer) {
        const id = feature.properties.name;
        if (id) {
          layer.bindTooltip(id, {
            permanent: true, direction: 'auto',
            className: 'poste-id-tooltip', offset: [0, -5] 
          });
        }
        let popupContent = id || "Poste Existente";
        if (feature.properties.description) {
          const descLimpia = feature.properties.description.replace(/(\r\n|\n|\r)/gm, "<br>");
          popupContent += `<br><hr>${descLimpia}`;
        }
        layer.bindPopup(popupContent);
      }
    });

    const kmlRunPostesEx = omnivore.kml(urlPostesExistentes, null, capaPostesExistentes);
    
    kmlRunPostesEx.on('ready', function() {
        clusterPA.addLayer(kmlRunPostesEx);
        map.addLayer(clusterPA);
        layerControl.addOverlay(clusterPA, "Postes Existentes PA");
    });
    

    // --- Bloque 2: Villa Reyes ---
    const urlPostesVR = "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/VR_postes%20existentes.kml";
    const clusterVR = L.markerClusterGroup(); // Cluster

    const capaPostesVR = L.geoJson(null, {
      pointToLayer: function (feature, latlng) {
        return L.marker(latlng, { icon: iconoPosteExistente });
      },
      onEachFeature: function (feature, layer) {
        const id = feature.properties.name;
        if (id) {
          layer.bindTooltip(id, {
            permanent: true, direction: 'auto',
            className: 'poste-id-tooltip', offset: [0, -5] 
          });
        }
        let popupContent = id || "Poste Existente";
        if (feature.properties.description) {
          const descLimpia = feature.properties.description.replace(/(\r\n|\n|\r)/gm, "<br>");
          popupContent += `<br><hr>${descLimpia}`;
        }
        layer.bindPopup(popupContent);
      }
    });

    const kmlRunVR = omnivore.kml(urlPostesVR, null, capaPostesVR);
    kmlRunVR.on('ready', function() {
        clusterVR.addLayer(kmlRunVR);
        map.addLayer(clusterVR);
        layerControl.addOverlay(clusterVR, "Postes Existentes VR");
    });

    // --- Bloque 3: Ventanilla Centro ---
    const urlPostesVC = "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/VC_postes%20existentes.kml";
    const clusterVC = L.markerClusterGroup(); // Cluster

    const capaPostesVC = L.geoJson(null, {
      pointToLayer: function (feature, latlng) {
        return L.marker(latlng, { icon: iconoPosteExistente });
      },
      onEachFeature: function (feature, layer) {
        const id = feature.properties.name;
        if (id) {
          layer.bindTooltip(id, {
            permanent: true, direction: 'auto',
            className: 'poste-id-tooltip', offset: [0, -5] 
          });
        }
        let popupContent = id || "Poste Existente";
        if (feature.properties.description) {
          const descLimpia = feature.properties.description.replace(/(\r\n|\n|\r)/gm, "<br>");
          popupContent += `<br><hr>${descLimpia}`;
        }
        layer.bindPopup(popupContent);
      }
    });

    const kmlRunVC = omnivore.kml(urlPostesVC, null, capaPostesVC);
    kmlRunVC.on('ready', function() {
        clusterVC.addLayer(kmlRunVC);
        map.addLayer(clusterVC);
        layerControl.addOverlay(clusterVC, "Postes Existentes VC");
    });


    // --- CAPAS DINÁMICAS (CON CLUSTERING) ---
    const capasDinamicas = [
      { nombre: "Postes Pachacutec", color: "#FFA500", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/PA_Postes_Act.kml" },
      { nombre: "Postes Villa Los Reyes", color: "#FF0000", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/VR_Postes_Act.kml" },
      { nombre: "Postes Ventanilla Centro", color: "#8000FF", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/VC_Postes_Act.kml" }
    ];

    const capasActivas = {};
    const dashboardData = {};

    // --- LEYENDA (Estática) ---
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend info-legend-box info-panel');
      div.innerHTML += '<h4>Zonas del Proyecto</h4>';
      rutas.forEach(r => {
        div.innerHTML += `<div><span style="background:${r.color}"></span>${r.nombre}</div>`;
      });
      return div;
    };
    legend.addTo(map);

    
    // --- DASHBOARD DE REPORTE (Dinámico) ---
    const dashboard = L.control({ position: 'topright' });
    dashboard.onAdd = function (map) {
      
      this._div = L.DomUtil.create('div', 'legend dashboard-box info-panel');
      
      L.DomEvent.disableClickPropagation(this._div);
      L.DomEvent.disableScrollPropagation(this._div);
      L.DomEvent.on(this._div, 'touchmove', L.DomEvent.stopPropagation);
      
      this._div.innerHTML = '<h4>Reporte de Postes</h4>';
      this._listContainer = L.DomUtil.create('div', 'dashboard-list', this._div);
      return this._div;
    };
    dashboard.addTo(map);
    

    // =======================================================
    // --- DASHBOARD PMIs (FIJOS) ---
    // =======================================================
    const pmiDashboard = L.control({ position: 'bottomleft' });

    pmiDashboard.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'legend pmi-dashboard-box info-panel');
      L.DomEvent.disableScrollPropagation(this._div);
      L.DomEvent.on(this._div, 'touchstart', L.DomEvent.stopPropagation);
      L.DomEvent.on(this._div, 'touchmove', L.DomEvent.stopPropagation);

      this._div.innerHTML = '<h4>Reporte de PMIs (Fijos)</h4>';
      this._listContainer = L.DomUtil.create('div', 'pmi-list', this._div); 
      return this._div;
    };
    pmiDashboard.addTo(map);

    // Función para actualizar el dashboard de PMIs
    function updatePmiDashboard() {
      const container = pmiDashboard._listContainer;
      if (!container) return;

      let html = '';
      const colorFijo = estiloPuntosFijos.fillColor; // Usa el color que ya definimos

      puntosFijosKML.forEach(p => {
        const count = pmiCounts[p.nombre] || 0; // Obtiene el conteo
        html += `<div>`;
        html += `<span style="background:${colorFijo};"></span>`; // Muestra el círculo de color
        html += `<strong>${p.nombre}:</strong> ${count}`;
        html += `</div>`;
      });
      container.innerHTML = html;
    }

    // Función para actualizar el contenido del dashboard
    function updateDashboard() {
      const container = dashboard._listContainer;
      if (!container) return;

      let html = '';
      
      capasDinamicas.forEach(c => {
        const nombreZona = c.nombre;
        const data = dashboardData[c.nombre] || [];
        const count = data.length;

        html += `<div class="dashboard-zone-summary">`;
        html += `<span class="summary-label"><strong>${c.nombre}:</strong> ${count} p.</span>`;
        
        if (count > 0) {
          html += ` <span class="toggle-list" data-zone="${c.nombre}">[+]</span>`;
        }
        html += `</div>`;
        
        html += `<ul class="dashboard-id-list" id="list-${c.nombre}" style="display:none;">`;
        html += `<li class="dashboard-list-header">${c.nombre}</li>`;
        
        data.sort((a, b) => a.id.localeCompare(b.id)); 
        
        data.forEach(item => {
          html += `<li class="dashboard-id-item" data-id="${item.id}" data-zone="${c.nombre}">${item.id}</li>`;
        });
        html += `</ul>`;
      });

      container.innerHTML = html;
      addDashboardListeners();
    }

    // Función para añadir listeners (TÁCTIL + CLICK)
    function addDashboardListeners() {
      
      const toggles = document.querySelectorAll('.toggle-list');
      const handleToggle = function(e) {
        e.preventDefault(); 
        const zone = this.getAttribute('data-zone');
        const list = document.getElementById(`list-${zone}`);
        if (list) {
          const isHidden = list.style.display === 'none';
          list.style.display = isHidden ? 'block' : 'none';
          this.textContent = isHidden ? '[-]' : '[+]';
        }
      };

      toggles.forEach(toggle => {
        toggle.addEventListener('click', handleToggle);
      });

      const items = document.querySelectorAll('.dashboard-id-item');
      const handleItemClick = function(e) {
        e.preventDefault(); 
        const id = this.getAttribute('data-id');
        const zone = this.getAttribute('data-zone');
        
        // --- MODIFICADO PARA CLUSTERING ---
        // Si el usuario hace clic en la lista, hay que buscar el punto en el cluster
        
        const posteData = dashboardData[zone].find(d => d.id === id);
        if (posteData && posteData.layer) {
          const layer = posteData.layer;
          const clusterGroup = capasActivas[zone]; // Recuperamos el grupo
          
          if (clusterGroup) {
             // Esta función mágica del plugin hace zoom hasta encontrar el punto y lo abre
             clusterGroup.zoomToShowLayer(layer, function () {
                layer.openPopup();
             });
          }
        }
      };

      items.forEach(item => {
        item.addEventListener('click', handleItemClick);
      });
    }

    // --- FUNCIÓN CENTRAL DE CARGA DE CAPAS (MODIFICADA PARA CLUSTER) ---
    function loadDynamicLayer(capaConfig) {
      const nombreCapa = capaConfig.nombre;

      if (capasActivas[nombreCapa]) {
        // Si ya existe, la quitamos del mapa (el cluster entero)
        map.removeLayer(capasActivas[nombreCapa]);
      }
      dashboardData[nombreCapa] = [];

      // Crear el Cluster Group para esta zona
      const clusterGroup = L.markerClusterGroup();

      const kmlLayer = omnivore.kml(capaConfig.url + "?t=" + Date.now());

      kmlLayer.on('ready', function() {
        this.eachLayer(function(layer) {
          const feature = layer.feature;
          const id = feature.properties.name;
          const metadata = feature.properties.description;

          if (metadata) {
            const popupContent = metadata.replace(/(\r\n|\n|\r)/gm, "<br>");
            layer.bindPopup(popupContent);
          }

          if (id) {
            layer.bindTooltip(id, {
              permanent: true, direction: 'auto',
              className: 'poste-id-tooltip', offset: [0, -10]
            });
            
            // Guardamos la referencia para el dashboard
            dashboardData[nombreCapa].push({ id: id, layer: layer });
          }
        });
        
        // Añadir los puntos al cluster
        clusterGroup.addLayer(kmlLayer);
        
        // Guardar el cluster en capasActivas (para poder borrarlo luego)
        capasActivas[nombreCapa] = clusterGroup;
        
        // Añadir el cluster al mapa
        map.addLayer(clusterGroup);
        
        updateDashboard();
      });
    }

    // --- CARGA INICIAL Y RECARGA AUTOMÁTICA ---
    capasDinamicas.forEach(loadDynamicLayer);

    setInterval(() => {
      console.log("Actualizando capas y dashboard...", new Date().toLocaleTimeString());
      capasDinamicas.forEach(loadDynamicLayer);
    }, 60000); // 1 minuto

    
    // --- GEOLOCALIZACIÓN ---
    const estiloUbicacion = {
      radius: 7,
      fillColor: "#1a73e8", color: "#fff",
      weight: 2,
      opacity: 1,
      fillOpacity: 0.9
    };
    let marcadorUbicacion = null; 
    
    L.Control.FindMe = L.Control.extend({
      onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const link = L.DomUtil.create('a', 'leaflet-control-zoom-in find-me-btn', container);
        link.href = '#';
        link.title = 'Encontrar mi ubicación';
        link.role = 'button';

        L.DomEvent.on(link, 'click', L.DomEvent.stop).on(link, 'click', function() {
          map.locate({
            setView: true,      
            maxZoom: 16,        
            watch: false,       
            enableHighAccuracy: true 
          });
        });
        
        return container;
      }
    });
    
    new L.Control.FindMe({ position: 'topleft' }).addTo(map);

    map.on('locationfound', function(e) {
      const latlng = e.latlng;
      
      if (!marcadorUbicacion) {
        marcadorUbicacion = L.circleMarker(latlng, estiloUbicacion).addTo(map);
        marcadorUbicacion.bindPopup("¡Estás aquí!");
      } else {
        marcadorUbicacion.setLatLng(latlng);
      }
      marcadorUbicacion.openPopup();
    });

    map.on('locationerror', function(e) {
      alert("No se pudo obtener tu ubicación. Asegúrate de dar permisos.\n\nError: " + e.message);
    });

    // --- OCULTAR LEYENDAS ---
    L.Control.ToggleLegends = L.Control.extend({
      onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const link = L.DomUtil.create('a', 'toggle-legends-btn', container);
        link.href = '#';
        link.title = 'Ocultar/Mostrar Leyendas';
        link.role = 'button';

        L.DomEvent.on(link, 'click', L.DomEvent.stop).on(link, 'click', function() {
          const panels = document.querySelectorAll('.info-panel');
          panels.forEach(panel => {
            panel.classList.toggle('hidden');
          });
        });
        
        return container;
      }
    });
    
    new L.Control.ToggleLegends({ position: 'topleft' }).addTo(map);
    
    // --- REGLA DE MEDICIÓN ---
    const measureControl = L.control.measure({
      position: 'topleft',
      primaryLengthUnit: 'meters',
      secondaryLengthUnit: 'kilometers',
      primaryAreaUnit: 'sqmeters',
      secondaryAreaUnit: undefined,
      activeColor: '#d80a0a',   // Color de la línea al medir
      completedColor: '#d80a0a' // Color de la línea terminada
    });
    measureControl.addTo(map);
    
    L.Measure.setLocale('es', {
      strings: {
        "measure": "Medir",
        "measureDistancesAndAreas": "Medir distancias y áreas",
        "createNewMeasurement": "Crear una nueva medición",
        "startCreating": "Comienza a medir haciendo clic en el mapa",
        "finishMeasurement": "Terminar medición",
        "lastPoint": "Último punto",
        "area": "Área",
        "totalLength": "Longitud Total",
        "meters": "Metros",
        "miles": "Millas",
        "sqmeters": "Metros cuadrados",
        "sqmiles": "Millas cuadradas",
        "acres": "Acres",
        "hectares": "Hectáreas",
        "Cancel": "Cancelar",
        "cancel": "cancelar",
        "deleteLastPoint": "Eliminar último punto",
        "example": "Ejemplo"
      }
    });
    measureControl.setLocale('es');

  </script>
</body>
</html>
