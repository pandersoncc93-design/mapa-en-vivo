<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa GPON – Ventanilla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    .legend {
      background: white;
      padding: 10px 14px;
      line-height: 1.5em;
      border-radius: 8px;
      font-family: Arial, sans-serif;
      font-size: 13px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .legend h4 {
      margin: 0 0 6px 0;
      font-size: 14px;
      text-align: center;
      color: #333;
    }
    
    .info-legend-box div {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .info-legend-box span {
      display: inline-block;
      width: 18px;
      height: 10px;
      margin-right: 8px;
      border: 1px solid #555;
    }
    
    .poste-id-tooltip {
      background: rgba(255, 255, 255, 0.75);
      border: none;
      box-shadow: none;
      font-weight: bold;
      font-size: 10px;
      color: #000;
      padding: 2px 4px;
      border-radius: 3px;
    }

    /* ESTILOS DASHBOARD */
    .dashboard-box {
      max-height: 300px;
      overflow-y: auto; /* Permite el scroll */
      width: 250px;
    }
    .dashboard-list {
      padding-left: 10px;
    }
    
    /* --- INICIO DE BLOQUE (CSS para Reporte PMIs) --- */
    .pmi-list {
      display: block; /* Asegura que la lista sea vertical */
    }
    .pmi-list > div {
      font-size: 12px; /* Letra más pequeña */
      display: flex;
      align-items: center;
      margin-bottom: 3px; /* Espacio reducido */
      flex-shrink: 0; /* Evita que se aplasten */
    }
    .pmi-dashboard-box span {
      width: 10px; /* Círculo más pequeño */
      height: 10px; /* Círculo más pequeño */
      border-radius: 50%;
      border: 1px solid #000;
      margin-right: 6px; /* Espacio reducido */
      display: inline-block;
      flex-shrink: 0; /* Evita que el círculo se aplaste */
    }
    /* --- FIN DE BLOQUE--- */
    
    .dashboard-zone-summary {
      margin-bottom: 5px;
      font-size: 13px;
    }
    
    .toggle-list {
      cursor: pointer;
      color: blue;
      font-family: monospace;
      font-weight: bold;
      padding: 0 5px;
    }
    .dashboard-id-list {
      list-style: none;
      padding-left: 15px;
      margin: 0;
      font-size: 11px;
    }
    .dashboard-id-item {
      cursor: pointer;
      padding: 2px;
      white-space: nowrap;
    }
    .dashboard-id-item:hover {
      background-color: #f0f0f0;
      font-weight: bold;
    }
    
    .dashboard-list-header {
      font-weight: bold;
      font-size: 12px;
      color: #555;
      margin: 5px 0;
      border-bottom: 1px solid #ccc;
      padding-bottom: 3px;
    }
    
    /* --- INICIO DE BLOQUE (Botón "Find Me") --- */
    .leaflet-bar a.find-me-btn {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="%23333" d="M256 0c-17.67 0-32 14.33-32 32v14.08C108.7 61.12 21.12 108.7 6.08 224H32c17.67 0 32 14.33 32 32s-14.33 32-32 32H6.08C21.12 403.3 108.7 490.9 224 505.9V480c0-17.67 14.33-32 32-32s32 14.33 32 32v25.92C403.3 490.9 490.9 403.3 505.9 288H480c-17.67 0-32-14.33-32-32s14.33-32 32-32h25.92C490.9 108.7 403.3 21.12 288 6.08V32c0-17.67-14.33-32-32-32zM256 128c-70.69 0-128 57.31-128 128s57.31 128 128 128 128-57.31 128-128-57.31-128-128-128zm0 192c-35.35 0-64-28.65-64-64s28.65-64 64-64 64 28.65 64 64-28.65 64-64 64z"/></svg>');
      background-size: 16px 16px;
      background-position: center;
      background-repeat: no-repeat;
    }
    /* --- FIN DE BLOQUE --- */

    /* --- INICIO BLOQUE (Ocultar Leyendas) --- */
    .leaflet-bar a.toggle-legends-btn {
      /* Icono de Menu ☰ */
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="18" height="18"><path fill="%23333" stroke="%23333" stroke-width="3" stroke-linecap="round" d="M4 7h22M4 15h22M4 23h22"/></svg>');
      background-size: 18px 18px;
      background-position: center;
      background-repeat: no-repeat;
    }
    .info-panel.hidden {
      display: none;
    }
    /* --- FIN BLOQUE --- */
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
       // --- MAPA BASE (CON SELECTOR) ---
    const map = L.map('map').setView([-11.87, -77.13], 13);
    
    // --- LÍNEA NUEVA (Almacén de conteo) ---
    const pmiCounts = {}; 
    
    // 1. Define los dos mapas base
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });
    
    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });
    
    // 2. Añade el mapa que quieres que se vea por defecto
    osm.addTo(map);
    
    // 3. Define el objeto de control
    const baseMaps = {
      "Calles (OpenStreetMap)": osm,
      "Satélite (Esri)": esriSat
    };
    
    // =======================================================
    // --- INICIO DE BLOQUE MODIFICADO (Control de Capas) ---
    // =======================================================
    
    // 4. Define el objeto para las capas de filtro (Overlays)
    const overlayMaps = {};

    // 5. Crea el control de capas (aún no lo añadimos al mapa)
    const layerControl = L.control.layers(baseMaps, overlayMaps, {
      position: 'topright' // Moverlo a la derecha
    });
    // =======================================================
    // --- FIN DE BLOQUE MODIFICADO ---
    // =======================================================
    
    
    // --- RUTAS ESTÁTICAS (Sin tilde) ---
    const rutas = [
      { nombre: "Pachacutec", color: "#FFA500", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/Rutas_Pachacutec.kml" },
      { nombre: "Villa Los Reyes", color: "#FF0000", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/Rutas_Villa%20los%20reyes.kml" },
      { nombre: "Ventanilla Centro", color: "#8000FF", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/Rutas_Ventanilla%20centro.kml" }
    ];

    // --- MODIFICADO: Carga de Rutas ---
    rutas.forEach(r => {
      const rutaLayer = omnivore.kml(r.url, null, L.geoJson(null, {
        style: { color: r.color, weight: 3, opacity: 0.9 }
      }));
      rutaLayer.addTo(map); // Añade al mapa por defecto
      layerControl.addOverlay(rutaLayer, "Ruta: " + r.nombre); // Añade al control
    });

  	// 1. PMIs (KML fijos)
  	const puntosFijosKML = [
  	  { nombre: "PMIs Pachacutec", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/PMIs%20Pachacutec.kml" },
  	  { nombre: "PMIs Ventanilla Centro", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/PMIs%20Ventanilla%20centro.kml" },
  	  { nombre: "PMIs Villa Los Reyes", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/PMIs%20Villa%20los%20reyes.kml" }
  	];
  
  	// 2. Define el estilo de los círculos
  	const estiloPuntosFijos = {
  	  radius: 8,
  	  fillColor: "#008f39", // Verde
  	  color: "#000",
  	  weight: 1,
  	  opacity: 1,
  	  fillOpacity: 0.8
  	};
  
    // =======================================================
    // --- INICIO DE BLOQUE MODIFICADO (Carga y Conteo de PMIs) ---
    // =======================================================
  	// 3. Carga cada KML, aplica estilo, añade tooltips y CUENTA los puntos
  	puntosFijosKML.forEach(p => {
  	  
  	  // Inicializa el contador para esta zona
  	  pmiCounts[p.nombre] = 0; 
  	  
  	  const capaPuntosFijos = L.geoJson(null, {
  		pointToLayer: function (feature, latlng) {
  		  // 1. Crea el Círculo-Marcador
  		  return L.circleMarker(latlng, estiloPuntosFijos);
  		},
  		onEachFeature: function (feature, layer) {
  		  // 2. Incrementa el contador por cada punto
  		  pmiCounts[p.nombre]++; 
  		  
  		  // 3. Añade Tooltip (ID)
  		  const id = feature.properties.name;
  		  let popupContent = id || "Punto Fijo";
  		  if (id) {
  			layer.bindTooltip(id, {
  			  permanent: true, direction: 'auto',
  			  className: 'poste-id-tooltip', offset: [0, -10]
  			});
  		  }

  		  // 4. Añade Popup (Descripción)
  		  if (feature.properties.description) {
  			const descLimpia = feature.properties.description.replace(/(\r\n|\n|\r)/gm, "<br>");
  			popupContent += `<br><hr>${descLimpia}`;
  		  }
  		  layer.bindPopup(popupContent);
  		}
  	  });
  	  
  	  // Carga el KML
  	  const kmlRun = omnivore.kml(p.url, null, capaPuntosFijos);
  	  kmlRun.addTo(map); // Añade al mapa por defecto
      layerControl.addOverlay(kmlRun, "PMI: " + p.nombre); // Añade al control
  	  
  	  // ¡CLAVE! Cuando el KML termine de cargar, actualiza el dashboard de PMIs
  	  kmlRun.on('ready', function() {
  		updatePmiDashboard();
  	  });
  	});
    // =======================================================
    // --- FIN DE BLOQUE MODIFICADO ---
    // =======================================================
   
    // --- AÑADE EL CONTROL DE CAPAS AL MAPA ---
    // (Lo añadimos aquí después de que todas las capas se han definido)
    layerControl.addTo(map);

    // --- CAPAS DINÁMICAS (Sin tilde) ---
    const capasDinamicas = [
      { nombre: "Postes Pachacutec", color: "#FFA500", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/PA_Postes_Act.kml" },
      { nombre: "Postes Villa Los Reyes", color: "#FF0000", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/VR_Postes_Act.kml" },
      { nombre: "Postes Ventanilla Centro", color: "#8000FF", url: "https://raw.githubusercontent.com/pandersoncc93-design/mapa-en-vivo/refs/heads/main/VC_Postes_Act.kml" }
    ];

    const capasActivas = {};
    const dashboardData = {};

    // --- LEYENDA (Estática) ---
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
      // --- MODIFICADO: Añadida clase 'info-panel' ---
      const div = L.DomUtil.create('div', 'legend info-legend-box info-panel');
      div.innerHTML += '<h4>Zonas del Proyecto</h4>';
      rutas.forEach(r => {
        div.innerHTML += `<div><span style="background:${r.color}"></span>${r.nombre}</div>`;
      });
      return div;
    };
    legend.addTo(map);

    
    // --- DASHBOARD DE REPORTE (Dinámico) ---
    const dashboard = L.control({ position: 'topright' });
    dashboard.onAdd = function (map) {
      
      // --- MODIFICADO: Añadida clase 'info-panel' ---
      this._div = L.DomUtil.create('div', 'legend dashboard-box info-panel');
      
      L.DomEvent.disableClickPropagation(this._div);
      L.DomEvent.disableScrollPropagation(this._div);
      L.DomEvent.on(this._div, 'touchmove', L.DomEvent.stopPropagation);
      
      this._div.innerHTML = '<h4>Reporte de Postes</h4>';
      this._listContainer = L.DomUtil.create('div', 'dashboard-list', this._div);
      return this._div;
    };
    dashboard.addTo(map);
    

    // =======================================================
    // --- INICIO DE BLOQUE: DASHBOARD PMIs (FIJOS) ---
    // =======================================================
    const pmiDashboard = L.control({ position: 'bottomleft' });

    pmiDashboard.onAdd = function (map) {
      // --- MODIFICADO: Añadida clase 'info-panel' ---
      this._div = L.DomUtil.create('div', 'legend pmi-dashboard-box info-panel');
      // Evitar que el scroll mueva el mapa
      L.DomEvent.disableScrollPropagation(this._div);
      L.DomEvent.on(this._div, 'touchstart', L.DomEvent.stopPropagation);
      L.DomEvent.on(this._div, 'touchmove', L.DomEvent.stopPropagation);

      this._div.innerHTML = '<h4>Reporte de PMIs (Fijos)</h4>';
      this._listContainer = L.DomUtil.create('div', 'pmi-list', this._div); 
      return this._div;
    };
    pmiDashboard.addTo(map);

    // Función para actualizar el dashboard de PMIs
    function updatePmiDashboard() {
      const container = pmiDashboard._listContainer;
      if (!container) return;

      let html = '';
      const colorFijo = estiloPuntosFijos.fillColor; // Usa el color que ya definimos

      puntosFijosKML.forEach(p => {
        const count = pmiCounts[p.nombre] || 0; // Obtiene el conteo
        html += `<div>`;
        html += `<span style="background:${colorFijo};"></span>`; // Muestra el círculo de color
        html += `<strong>${p.nombre}:</strong> ${count}`;
        html += `</div>`;
      });
      container.innerHTML = html;
    }
    // =======================================================
    // --- FIN DE BLOQUE ---
    // =======================================================


    // Función para actualizar el contenido del dashboard
    function updateDashboard() {
      const container = dashboard._listContainer;
      if (!container) return;

      let html = '';
      
      capasDinamicas.forEach(c => {
        const nombreZona = c.nombre;
        const data = dashboardData[c.nombre] || [];
        const count = data.length;

        html += `<div class="dashboard-zone-summary">`;
        html += `<span class="summary-label"><strong>${c.nombre}:</strong> ${count} p.</span>`;
        
        if (count > 0) {
          html += ` <span class="toggle-list" data-zone="${c.nombre}">[+]</span>`;
        }
        html += `</div>`;
        
        html += `<ul class="dashboard-id-list" id="list-${c.nombre}" style="display:none;">`;
        html += `<li class="dashboard-list-header">${c.nombre}</li>`;
        
        data.sort((a, b) => a.id.localeCompare(b.id)); 
        
        data.forEach(item => {
          html += `<li class="dashboard-id-item" data-id="${item.id}" data-zone="${c.nombre}">${item.id}</li>`;
        });
        html += `</ul>`;
      });

      container.innerHTML = html;
      addDashboardListeners();
    }

    // Función para añadir listeners (TÁCTIL + CLICK)
    function addDashboardListeners() {
      
      // 1. Listeners para botones de expandir/colapsar [+]
      const toggles = document.querySelectorAll('.toggle-list');
      const handleToggle = function(e) {
        e.preventDefault(); 
        const zone = this.getAttribute('data-zone');
        const list = document.getElementById(`list-${zone}`);
        if (list) {
          const isHidden = list.style.display === 'none';
          list.style.display = isHidden ? 'block' : 'none';
          this.textContent = isHidden ? '[-]' : '[+]';
        }
      };

      toggles.forEach(toggle => {
        toggle.addEventListener('click', handleToggle);
        // HEMOS QUITADO 'touchstart' DE AQUÍ
      });

      // 2. Listeners para items de la lista (el ID del poste)
      const items = document.querySelectorAll('.dashboard-id-item');
      const handleItemClick = function(e) {
        e.preventDefault(); 
        const id = this.getAttribute('data-id');
        const zone = this.getAttribute('data-zone');
        
        const posteData = dashboardData[zone].find(d => d.id === id);
        if (posteData && posteData.layer) {
          const layer = posteData.layer;
          
          map.flyTo(layer.getLatLng(), 18);
          layer.openPopup();
        }
      };

      items.forEach(item => {
        item.addEventListener('click', handleItemClick);
         // HEMOS QUITADO 'touchstart' DE AQUÍ
      });
    }

    // --- FUNCIÓN CENTRAL DE CARGA DE CAPAS ---
    function loadDynamicLayer(capaConfig) {
      const nombreCapa = capaConfig.nombre;

      if (capasActivas[nombreCapa]) {
        map.removeLayer(capasActivas[nombreCapa]);
      }
      dashboardData[nombreCapa] = [];

      const kmlLayer = omnivore.kml(capaConfig.url + "?t=" + Date.now());

      kmlLayer.on('ready', function() {
        this.eachLayer(function(layer) {
          const feature = layer.feature;
          const id = feature.properties.name;
          
          // --- ¡AQUÍ ESTÁ LA CORRECCIÓN! ---
          // Era feature.properties.description, no feature.form
          const metadata = feature.properties.description;

          if (metadata) {
            const popupContent = metadata.replace(/(\r\n|\n|\r)/gm, "<br>");
            layer.bindPopup(popupContent);
          }

          if (id) {
            layer.bindTooltip(id, {
              permanent: true, direction: 'auto',
              className: 'poste-id-tooltip', offset: [0, -10]
            });
            
            dashboardData[nombreCapa].push({ id: id, layer: layer });
          }
        });
        
        // Esta función ahora sí se llamará
        updateDashboard();
      });

      capasActivas[nombreCapa] = kmlLayer;
      kmlLayer.addTo(map);
    }

    // --- CARGA INICIAL Y RECARGA AUTOMÁTICA ---
    capasDinamicas.forEach(loadDynamicLayer);

    setInterval(() => {
      console.log("Actualizando capas y dashboard...", new Date().toLocaleTimeString());
      capasDinamicas.forEach(loadDynamicLayer);
    }, 60000); // 1 minuto

    
    const estiloUbicacion = {
      radius: 7,
      fillColor: "#1a73e8", color: "#fff",
      weight: 2,
      opacity: 1,
      fillOpacity: 0.9
    };
    let marcadorUbicacion = null; L.Control.FindMe = L.Control.extend({
      onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const link = L.DomUtil.create('a', 'leaflet-control-zoom-in find-me-btn', container);
        link.href = '#';
        link.title = 'Encontrar mi ubicación';
        link.role = 'button';

        L.DomEvent.on(link, 'click', L.DomEvent.stop).on(link, 'click', function() {
          map.locate({
            setView: true,      maxZoom: 16,        watch: false,       enableHighAccuracy: true });
        });
        
        return container;
      }
    });
    
    new L.Control.FindMe({ position: 'topleft' }).addTo(map);

    map.on('locationfound', function(e) {
      const latlng = e.latlng;
      
      if (!marcadorUbicacion) {
        marcadorUbicacion = L.circleMarker(latlng, estiloUbicacion).addTo(map);
        marcadorUbicacion.bindPopup("¡Estás aquí!");
      } else {
        marcadorUbicacion.setLatLng(latlng);
      }
      marcadorUbicacion.openPopup();
    });

    map.on('locationerror', function(e) {
      alert("No se pudo obtener tu ubicación. Asegúrate de dar permisos.\n\nError: " + e.message);
    });

    // =======================================================
    // --- INICIO DE BLOQUE NUEVO (Ocultar Leyendas) ---
    // =======================================================
    L.Control.ToggleLegends = L.Control.extend({
      onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const link = L.DomUtil.create('a', 'toggle-legends-btn', container);
        link.href = '#';
        link.title = 'Ocultar/Mostrar Leyendas';
        link.role = 'button';

        L.DomEvent.on(link, 'click', L.DomEvent.stop).on(link, 'click', function() {
          const panels = document.querySelectorAll('.info-panel');
          panels.forEach(panel => {
            panel.classList.toggle('hidden');
          });
        });
        
        return container;
      }
    });
    
    // Añade el botón (debajo del zoom y 'find me')
    new L.Control.ToggleLegends({ position: 'topleft' }).addTo(map);
    
    // =======================================================
    // --- FIN DE BLOQUE NUEVO ---
    // =======================================================

    </script>
</body>
</html>
